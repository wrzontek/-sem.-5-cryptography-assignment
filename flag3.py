import string
from os import urandom
from pwn import *
import numpy as np

CHARSET = string.ascii_letters + string.digits + '{}_'

### prosty eksperyment, który ukazuje niedostateczną losowość metody, którą wykorzystamy do odzyskania flagi

# freq = [0 for i in range(len(CHARSET))]
#
# for i in range(500000):
#     key = urandom(1)[0] % len(CHARSET)
#     freq[(CHARSET.index('a') + key) % len(CHARSET)] += 1
#
# for i in range(len(CHARSET)):
#     print(CHARSET[i], i, ":", freq[i] * 100 / 500000)

### jeśli 'a' to 61-64 najrzadziej się pojawiają
### jeśli 'b' to 62-0 najrzadziej się pojawiają
### jeśli 'd' to 63-1 najrzadziej się pojawiają
### jeśli CHARSET.index(char) = i to [(61 + i) % len(CHARSET), (64 + i) % len(CHARSET)] najrzadziej się pojawiają

### trzeba poprosić o encryptedflag dziesiątki tysięcy razy
### wypełnić freq[len(flag)][len(CHARSET)] i stosować powyższą obserwację do odzyskania flagi

### poniższe to kod który wykorzystałem do łączenia z serwerem, jest brzydki ale działa

# conn = remote('cryptotask.var.tailcall.net', 30000)
# conn.recvuntil(b'7) Get encrypted flag')
# conn.recvline()
#
# conn.send(b'7\n')
# conn.recvuntil(b'Encrypted FLAG3: ')
# flagLength = len(conn.recvline()) - 1
# conn.recvuntil(b'7) Get encrypted flag')
# conn.clean()
#
# conn.send(b'7\n')
# conn.recv(323)
# conn.send(b'7\n')
# conn.recv(323)
# # dla każdego znaku we fladze będziemy patrzeć jak często pojawiają się na jego indeksie konkretne znaki
# freq = np.array([[0 for i in range(len(CHARSET))] for j in range(flagLength)])
#
# for i in range(100000):
#     # wszystkie liczby brzydko pohardkodowane żeby szybciej działało
#     conn.send(b'7\n')
#     received = conn.recv(323)
#     encryptedFlag = received[17:51]
#
#     for j in range(len(freq)):
#         freq[j][CHARSET.index(chr(encryptedFlag[j]))] += 1
#
#     if i % 100 == 0:
#         print(i, freq.tolist())

freq = [[1149, 848, 847, 880, 791, 1137, 1113, 1156, 1107, 1106, 1169, 1116, 1151, 1098, 1130, 1105, 1141, 1117, 1074, 1145, 1119, 1107, 1136, 1101, 1106, 1170, 1145, 1092, 1151, 1145, 1105, 1117, 1118, 1131, 1096, 1119, 1130, 1145, 1054, 1192, 1181, 1072, 1145, 1140, 1154, 1126, 1130, 1057, 1186, 1151, 1192, 1150, 1169, 1085, 1076, 1155, 1090, 1099, 1136, 1104, 1104, 1103, 1107, 1128, 1102], [1163, 1111, 1132, 1082, 1104, 1069, 1112, 809, 872, 846, 856, 1148, 1069, 1039, 1115, 1193, 1078, 1140, 1106, 1105, 1147, 1111, 1165, 1130, 1135, 1212, 1157, 1100, 1186, 1115, 1122, 1097, 1173, 1131, 1096, 1118, 1076, 1199, 1153, 1110, 1105, 1111, 1144, 1095, 1108, 1123, 1076, 1167, 1189, 1134, 1106, 1121, 1149, 1105, 1151, 1160, 1142, 1108, 1105, 1142, 1122, 1121, 1129, 1093, 1113], [1212, 1082, 1111, 1178, 1067, 1068, 1123, 1139, 1123, 1122, 1158, 1136, 1127, 1111, 1144, 1143, 1174, 1159, 1128, 1148, 1146, 1110, 1137, 1068, 1125, 1153, 1142, 1127, 1117, 1112, 1131, 1097, 1122, 1110, 1132, 1149, 1088, 1112, 1061, 1113, 1108, 1110, 1159, 1098, 1185, 1114, 1149, 1085, 1093, 1112, 1161, 1148, 1120, 1106, 1068, 1161, 1105, 1121, 1158, 1157, 1111, 869, 834, 827, 837], [1077, 1177, 803, 834, 747, 864, 1110, 1164, 1145, 1120, 1120, 1105, 1179, 1049, 1093, 1124, 1137, 1119, 1087, 1095, 1108, 1191, 1091, 1220, 1104, 1082, 1149, 1177, 1103, 1083, 1093, 1106, 1154, 1196, 1130, 1088, 1201, 1083, 1116, 1085, 1155, 1156, 1190, 1138, 1144, 1121, 1100, 1138, 1092, 1151, 1167, 1101, 1060, 1134, 1103, 1136, 1199, 1109, 1148, 1069, 1167, 1069, 1117, 1182, 1146], [1122, 1128, 1110, 1141, 1130, 1141, 1141, 1087, 1154, 1094, 1122, 1111, 1213, 1152, 1127, 1176, 1079, 1106, 1190, 1136, 1112, 1128, 1134, 1087, 1138, 1113, 1132, 1096, 1133, 1119, 1118, 1146, 1098, 1122, 1102, 1057, 1154, 1158, 1172, 1079, 1110, 1114, 1162, 1109, 1140, 1020, 1101, 1100, 1167, 1140, 1159, 1159, 1139, 1096, 1139, 1153, 1125, 1081, 842, 862, 875, 830, 1134, 1057, 1129], [1125, 1153, 1078, 1140, 1119, 1169, 1121, 1143, 1121, 1146, 1148, 1137, 1110, 1126, 1096, 1134, 1131, 1148, 1185, 1097, 1124, 1071, 1215, 1144, 1120, 1155, 1095, 1158, 1152, 1106, 1147, 1133, 1062, 1122, 1116, 1157, 1108, 1132, 1045, 1046, 1165, 1147, 1105, 1144, 1112, 1153, 1126, 1126, 1144, 1116, 1104, 1125, 1102, 1121, 1118, 854, 856, 817, 881, 1121, 1096, 1065, 1150, 1131, 1087], [1143, 1118, 1130, 846, 832, 850, 817, 1142, 1117, 1141, 1141, 1108, 1134, 1113, 1132, 1163, 1140, 1116, 1102, 1158, 1070, 1101, 1105, 1132, 1128, 1125, 1157, 1148, 1085, 1074, 1125, 1122, 1145, 1139, 1160, 1165, 1133, 1099, 1141, 1131, 1111, 1026, 1214, 1051, 1050, 1119, 1140, 1144, 1158, 1110, 1177, 1194, 1125, 1047, 1065, 1173, 1130, 1134, 1112, 1181, 1089, 1192, 1116, 1130, 1085], [1141, 1118, 1103, 1094, 1143, 1121, 1135, 1087, 1095, 1141, 1091, 1125, 1153, 1098, 1117, 1062, 1194, 1141, 1107, 1136, 1091, 1170, 1127, 1126, 1117, 1108, 1174, 1144, 1160, 1173, 1112, 1100, 1108, 1107, 1107, 1152, 1122, 1115, 1185, 1127, 1062, 1085, 1181, 1166, 1126, 1177, 1118, 1101, 1159, 1146, 1180, 1107, 853, 785, 855, 822, 1111, 1119, 1145, 1076, 1097, 1111, 1162, 1141, 1089], [1084, 1047, 1110, 1162, 1115, 1096, 1139, 1108, 1108, 1130, 1116, 1124, 1136, 1147, 1125, 847, 828, 841, 852, 1159, 1153, 1045, 1101, 1146, 1149, 1083, 1114, 1177, 1127, 1071, 1143, 1130, 1111, 1105, 1146, 1184, 1156, 1125, 1080, 1134, 1160, 1146, 1178, 1141, 1146, 1161, 1133, 1135, 1078, 1155, 1071, 1117, 1152, 1157, 1144, 1130, 1172, 1093, 1119, 1119, 1150, 1090, 1175, 1087, 1038], [1143, 1161, 1176, 1144, 1122, 1148, 1131, 1093, 1121, 1179, 1136, 1140, 1161, 1183, 1137, 1086, 1066, 1117, 1112, 1092, 1135, 1126, 1159, 1180, 1110, 1129, 1157, 1070, 1111, 1156, 1155, 1117, 1141, 1107, 1149, 1156, 1018, 1108, 1072, 1063, 1148, 1139, 1114, 1121, 1147, 1176, 1129, 1127, 1104, 1105, 1090, 1110, 1096, 1109, 1130, 1112, 1070, 1086, 1158, 1157, 824, 881, 885, 802, 1114], [1130, 1181, 1147, 1074, 1088, 1099, 1150, 1110, 1129, 1132, 1081, 1088, 1130, 1147, 1118, 1077, 1147, 1158, 1080, 1162, 1121, 1115, 1119, 1097, 1114, 1084, 1188, 1153, 1147, 1139, 1168, 1114, 830, 825, 827, 836, 1102, 1164, 1128, 1133, 1130, 1123, 1099, 1084, 1138, 1148, 1187, 1086, 1075, 1040, 1122, 1122, 1143, 1166, 1135, 1191, 1148, 1157, 1142, 1144, 1121, 1124, 1143, 1097, 1104], [1117, 1110, 1141, 1113, 1168, 1125, 1106, 1166, 1092, 1088, 1141, 1149, 1143, 1113, 1129, 1133, 1140, 1157, 1082, 1121, 1135, 1128, 1100, 1124, 1146, 1102, 1050, 1129, 1071, 1131, 1072, 1161, 1171, 1107, 1060, 1143, 1122, 1132, 1088, 1098, 1168, 1155, 1135, 1123, 1185, 1107, 1116, 1091, 1165, 1166, 1108, 821, 845, 828, 854, 1164, 1152, 1088, 1082, 1177, 1105, 1185, 1120, 1108, 1149], [1101, 1165, 1137, 1108, 1162, 1038, 1079, 1152, 1129, 1163, 1109, 1099, 1150, 1159, 1152, 1131, 1088, 1159, 1137, 1155, 859, 871, 842, 830, 1114, 1156, 1165, 1139, 1061, 1137, 1086, 1130, 1070, 1069, 1093, 1089, 1142, 1123, 1150, 1137, 1158, 1157, 1138, 1060, 1164, 1106, 1160, 1153, 1130, 1131, 1125, 1048, 1102, 1077, 1089, 1142, 1140, 1165, 1158, 1152, 1198, 1130, 1081, 1104, 1097], [1109, 1159, 1086, 1088, 1149, 1104, 1126, 1126, 1220, 1203, 1083, 1118, 1112, 1130, 1120, 1131, 1143, 1087, 1101, 1110, 1121, 1070, 1181, 1130, 1148, 1138, 1095, 1142, 1103, 1153, 1112, 1100, 1142, 1098, 1188, 1131, 1065, 1105, 1127, 1136, 1172, 1138, 1096, 1183, 1134, 1123, 1137, 1142, 1120, 1183, 1120, 1084, 1118, 1171, 1097, 1070, 1043, 1095, 1090, 1132, 847, 872, 832, 858, 1154], [1054, 1103, 1079, 1139, 1078, 1159, 1142, 1065, 1117, 1120, 1140, 1182, 1132, 1131, 1109, 1128, 1111, 1123, 842, 880, 871, 865, 1141, 1156, 1068, 1135, 1128, 1108, 1038, 1077, 1179, 1174, 1136, 1171, 1210, 1081, 1117, 1136, 1152, 1085, 1136, 1152, 1163, 1062, 1134, 1104, 1135, 1147, 1116, 1140, 1107, 1154, 1126, 1056, 1126, 1140, 1135, 1103, 1126, 1131, 1160, 1102, 1133, 1136, 1115], [1114, 1085, 1135, 1106, 1179, 1163, 1103, 1112, 1138, 1130, 1174, 1113, 1081, 1157, 1102, 1093, 1129, 1123, 1113, 1120, 1177, 1135, 892, 808, 798, 874, 1132, 1150, 1123, 1073, 1131, 1122, 1090, 1100, 1120, 1158, 1156, 1152, 1142, 1137, 1158, 1146, 1110, 1123, 1066, 1069, 1098, 1088, 1135, 1045, 1217, 1164, 1113, 1164, 1130, 1140, 1140, 1104, 1148, 1077, 1155, 1077, 1105, 1126, 1163], [1135, 1165, 1143, 1143, 1131, 1126, 1145, 1172, 1116, 1150, 1141, 1075, 1092, 1039, 882, 829, 859, 838, 1159, 1112, 1140, 1104, 1119, 1125, 1156, 1138, 1112, 1136, 1108, 1161, 1084, 1133, 1105, 1129, 1085, 1149, 1117, 1157, 1125, 1163, 1158, 1122, 1135, 1052, 1031, 1065, 1107, 1100, 1154, 1114, 1126, 1124, 1075, 1104, 1160, 1180, 1192, 1122, 1129, 1161, 1168, 1118, 1085, 1074, 1147], [1117, 1138, 1109, 1085, 1089, 1071, 1089, 1100, 1096, 1094, 1140, 1125, 1120, 1078, 1164, 1155, 1036, 1147, 1106, 1090, 1164, 1090, 1171, 1096, 1108, 1104, 1128, 1104, 1075, 1115, 1182, 1069, 1121, 1156, 1115, 835, 893, 893, 848, 1150, 1182, 1111, 1152, 1155, 1058, 1117, 1136, 1159, 1166, 1120, 1172, 1125, 1102, 1134, 1147, 1152, 1109, 1094, 1149, 1179, 1179, 1150, 1101, 1145, 1141], [1102, 1140, 1027, 1136, 1108, 1207, 1135, 1097, 1114, 1091, 1047, 1119, 1117, 1137, 1108, 1157, 1132, 1141, 1120, 1189, 1124, 1102, 1112, 1144, 1094, 1111, 1100, 1140, 1108, 1114, 1062, 1124, 1149, 1155, 1135, 1153, 1068, 1125, 1147, 1122, 1153, 888, 817, 823, 903, 1134, 1138, 1058, 1087, 1165, 1171, 1122, 1148, 1181, 1151, 1139, 1123, 1137, 1134, 1155, 1123, 1052, 1147, 1099, 1140], [1108, 1120, 1145, 1096, 1133, 1162, 1085, 1151, 1150, 1133, 1154, 1184, 1055, 1170, 1102, 1094, 1150, 1104, 1141, 1083, 1145, 1128, 1159, 1118, 1130, 1185, 1219, 1147, 1128, 1112, 1144, 1137, 1120, 1129, 1086, 1145, 1135, 1082, 1096, 1164, 1183, 1102, 1135, 1152, 1043, 1085, 1113, 1134, 1066, 1154, 1065, 1083, 1123, 1106, 1130, 1109, 1162, 1133, 1102, 1169, 823, 776, 856, 844, 1124], [1122, 1127, 1134, 1149, 1062, 1094, 1156, 1113, 1152, 1137, 1138, 1162, 1116, 830, 817, 906, 808, 1156, 1112, 1078, 1055, 1114, 1148, 1144, 1121, 1083, 1174, 1124, 1094, 1160, 1169, 1124, 1076, 1120, 1069, 1125, 1108, 1145, 1091, 1137, 1104, 1113, 1133, 1136, 1107, 1125, 1140, 1119, 1149, 1066, 1138, 1105, 1153, 1088, 1119, 1181, 1176, 1229, 1111, 1133, 1125, 1106, 1141, 1170, 1084], [1179, 1146, 1095, 1103, 1153, 1086, 1135, 1134, 1153, 1093, 1085, 1176, 1143, 1121, 1108, 1177, 1165, 1143, 1109, 1152, 1132, 1161, 1145, 1091, 1151, 1065, 1100, 1184, 1124, 1105, 1157, 1116, 1099, 1136, 1137, 1137, 1055, 1153, 1121, 1109, 1087, 1199, 1059, 1139, 1104, 1113, 1121, 1082, 1133, 1141, 1063, 822, 823, 878, 857, 1048, 1143, 1072, 1161, 1133, 1077, 1131, 1097, 1196, 1188], [1205, 1099, 1113, 1145, 1168, 1196, 1096, 1073, 1130, 1074, 1086, 1118, 1048, 1126, 1094, 1118, 1148, 1144, 1127, 1091, 1144, 1148, 1101, 1156, 1034, 1122, 1142, 1159, 1068, 1113, 1082, 1109, 1136, 1118, 1123, 1160, 1112, 1153, 1116, 1173, 1100, 1111, 1120, 1142, 1070, 1074, 1088, 1212, 1116, 1128, 1175, 1104, 835, 864, 842, 837, 1149, 1150, 1183, 1060, 1163, 1186, 1094, 1164, 1166], [1165, 1132, 1145, 1117, 1185, 1155, 1059, 820, 847, 864, 813, 1099, 1115, 1132, 1123, 1070, 1114, 1127, 1113, 1171, 1122, 1138, 1095, 1057, 1061, 1154, 1141, 1091, 1110, 1087, 1102, 1123, 1155, 1168, 1146, 1141, 1128, 1108, 1108, 1120, 1162, 1139, 1143, 1134, 1154, 1159, 1093, 1171, 1136, 1145, 1089, 1188, 1070, 1151, 1117, 1150, 1141, 1098, 1165, 1105, 1123, 1121, 1111, 1146, 1069], [1130, 1181, 1093, 1122, 1122, 1070, 1125, 1122, 1102, 1162, 1115, 1158, 1171, 1120, 1079, 1087, 1093, 1199, 1116, 1129, 1122, 1079, 1147, 1227, 1160, 1120, 1112, 1114, 1077, 1076, 1143, 1044, 1159, 1198, 1142, 1118, 1128, 1118, 1077, 1158, 1092, 1125, 1119, 1150, 1128, 1088, 1164, 1076, 1092, 833, 875, 859, 861, 1111, 1108, 1150, 1152, 1115, 1114, 1114, 1140, 1144, 1162, 1069, 1145], [1098, 1179, 1055, 1129, 1086, 1111, 1149, 1160, 1153, 1105, 1093, 1151, 1157, 1123, 1205, 1146, 1021, 1178, 1140, 1136, 832, 849, 900, 820, 1095, 1141, 1090, 1096, 1201, 1123, 1131, 1105, 1145, 1131, 1095, 1081, 1190, 1116, 1120, 1120, 1163, 1125, 1138, 1112, 1118, 1121, 1103, 1071, 1047, 1129, 1144, 1161, 1158, 1096, 1070, 1109, 1128, 1142, 1128, 1151, 1094, 1137, 1138, 1152, 1110], [1102, 1103, 1131, 1128, 1119, 1069, 1136, 1142, 1132, 1148, 1121, 1108, 1141, 1117, 1087, 1117, 1142, 1098, 1135, 1113, 1082, 1126, 1066, 1099, 1232, 1171, 1175, 1156, 1220, 1032, 1106, 1162, 1118, 1129, 1135, 1197, 1135, 1141, 1128, 1157, 1150, 1168, 1058, 1178, 1101, 1137, 1152, 1139, 1118, 1096, 1108, 1080, 1175, 1172, 1090, 1076, 1176, 1101, 1097, 1091, 836, 785, 818, 812, 1131], [1153, 1110, 1091, 1072, 1162, 1139, 1102, 1123, 1148, 1096, 1139, 1117, 1089, 827, 836, 841, 880, 1113, 1160, 1136, 1051, 1165, 1154, 1107, 1130, 1141, 1079, 1157, 1131, 1116, 1136, 1171, 1139, 1159, 1114, 1207, 1130, 1144, 1125, 1105, 1181, 1134, 1094, 1163, 1091, 1121, 1137, 1127, 1070, 1120, 1145, 1145, 1098, 1084, 1075, 1089, 1147, 1117, 1159, 1080, 1095, 1174, 1164, 1079, 1117], [1134, 1137, 1127, 1130, 1137, 1080, 1128, 1083, 1146, 1102, 1106, 1165, 1118, 1089, 1101, 1157, 1110, 1113, 1214, 1173, 1074, 1159, 827, 842, 788, 851, 1164, 1141, 1096, 1191, 1074, 1140, 1148, 1090, 1115, 1128, 1122, 1110, 1153, 1147, 1101, 1158, 1080, 1130, 1143, 1158, 1150, 1107, 1092, 1081, 1131, 1199, 1087, 1125, 1131, 1090, 1134, 1109, 1175, 1182, 1132, 1149, 1069, 1098, 1080], [1066, 1136, 1121, 1129, 1159, 1111, 1133, 1136, 1171, 866, 909, 842, 824, 1082, 1113, 1080, 1097, 1082, 1136, 1119, 1068, 1122, 1120, 1107, 1106, 1058, 1089, 1141, 1121, 1136, 1122, 1145, 1148, 1135, 1135, 1110, 1104, 1138, 1045, 1126, 1098, 1123, 1079, 1175, 1195, 1078, 1186, 1100, 1209, 1096, 1127, 1153, 1134, 1163, 1199, 1099, 1115, 1122, 1210, 1128, 1151, 1122, 1120, 1126, 1105], [855, 841, 866, 1165, 1106, 1061, 1081, 1101, 1137, 1109, 1163, 1077, 1115, 1178, 1126, 1075, 1161, 1193, 1123, 1162, 1133, 1153, 1148, 1102, 1152, 1146, 1072, 1119, 1099, 1095, 1181, 1065, 1121, 1127, 1109, 1143, 1154, 1156, 1119, 1170, 1131, 1113, 1130, 1142, 1159, 1204, 1126, 1106, 1111, 1178, 1077, 1166, 1125, 1061, 1079, 1140, 1097, 1122, 1161, 1082, 1131, 1105, 1082, 1118, 796], [1166, 1100, 1137, 1137, 1062, 1130, 1157, 1052, 1201, 1118, 1138, 1123, 1113, 1094, 1126, 1109, 1137, 1172, 1196, 1149, 1175, 1157, 1104, 1092, 1150, 1072, 1152, 1064, 1083, 1138, 1159, 1078, 1181, 1096, 1123, 1122, 1085, 1083, 1164, 1153, 1115, 1166, 1107, 1126, 1153, 1163, 1103, 1122, 892, 815, 850, 879, 1115, 1024, 1111, 1179, 1099, 1070, 1059, 1112, 1150, 1142, 1093, 1148, 1160], [1117, 1135, 1115, 1094, 1119, 1066, 1102, 1108, 1098, 1149, 1126, 1167, 1096, 1133, 1144, 1144, 1168, 1150, 1167, 1178, 1102, 1110, 1097, 1122, 1088, 1086, 1127, 1120, 1151, 1167, 1113, 1039, 1167, 1160, 889, 850, 824, 861, 1144, 1200, 1124, 1090, 1142, 1161, 1159, 1110, 1067, 1107, 1113, 1100, 1126, 1081, 1111, 1147, 1139, 1141, 1122, 1110, 1139, 1110, 1112, 1097, 1066, 1140, 1194], [1061, 1136, 1130, 1083, 1120, 1168, 1155, 1079, 1153, 1131, 1111, 1086, 1128, 1093, 1125, 1066, 1167, 1101, 1129, 1141, 1071, 1180, 1161, 1152, 1141, 1144, 1052, 1168, 1154, 1086, 1108, 1138, 1159, 1187, 1085, 1099, 1169, 1144, 1052, 1123, 1090, 1150, 1136, 1108, 1119, 1123, 1140, 1179, 1056, 1176, 1118, 1135, 1074, 1212, 1160, 1141, 1075, 1200, 1070, 795, 831, 855, 841, 1135, 1146]]
# powyższe to freq otrzymany po około 70k obrotach, na moim komputerze chodziło to ponad godzinę
# zapewne znacznie mniej niż 70k wystarczyłoby, jednak skoro zadanie nie narzuca limitu czasu to lepiej mieć pewność

def find_least_common_four_end_index(array):
    min_sum = 99999999
    min_index = -1
    for i in range(len(array)):
        sum_four = 0
        for j in range(4):
            sum_four += array[(i + j) % len(array)]
        if sum_four < min_sum:
            min_sum = sum_four
            min_index = (i + 3) % len(array)
    return min_index

flag = ''
for i in range(len(freq)):
    # jeśli CHARSET.index(char) = i to [(61 + i) % len(CHARSET), (64 + i) % len(CHARSET)] najrzadziej się pojawiają
    leastCommon = find_least_common_four_end_index(freq[i])  # i w (64 + i) % len(CHARSET)
    flag += CHARSET[(leastCommon + 1) % len(CHARSET)]

print(flag)  # flag{7h4t_K3y_wAsNT_r34l1y_rAnd0M}


